using System;
using System.Text;
using System.Collections;
using System.Xml;
using System.Data;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;
using System.Resources;
using System.Reflection;
using System.Globalization;
using System.Threading;

using Telerik.WebControls;
using UFSoft.UBF.UI.WebControls;
using UFSoft.UBF.UI.Controls;
using UFSoft.UBF.Util.Log;
using UFSoft.UBF.Util.Globalization;

using UFSoft.UBF.UI.IView;
using UFSoft.UBF.UI.Engine;
using UFSoft.UBF.UI.MD.Runtime;
using UFSoft.UBF.UI.ActionProcess;
using UFSoft.UBF.UI.WebControls.ClientCallBack;
using System.Collections.Generic;
using UFIDA.U9.UI.PDHelper;
using UFSoft.UBF.UI.WebControls.Association;
using UFSoft.UBF.UI.WebControls.Association.Adapter;
using UFSoft.UBF.UI.ControlModel;



/***********************************************************************************************
 * Form ID: 
 * UIFactory Auto Generator 
 ***********************************************************************************************/
namespace UFIDA.U9.Cust.GS.FT.BillNoAllocationUIModel
{
    public partial class BillNoAllocationUIFormWebPart
    {
        #region Custome eventBind
	
		 
				//BtnFind_Click...
		private void BtnFind_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnFind_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnSave_Click...
		private void BtnSave_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnSave_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnCancel_Click...
		private void BtnCancel_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnCancel_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnAdd_Click...
		private void BtnAdd_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnAdd_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnDelete_Click...
		private void BtnDelete_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnDelete_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnCopy_Click...
		private void BtnCopy_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnCopy_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnSubmit_Click...
		private void BtnSubmit_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnSubmit_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnApprove_Click...
		private void BtnApprove_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnApprove_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnList_Click...
		private void BtnList_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnList_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnFirstPage_Click...
		private void BtnFirstPage_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnFirstPage_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnPrevPage_Click...
		private void BtnPrevPage_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnPrevPage_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnNextPage_Click...
		private void BtnNextPage_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnNextPage_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnLastPage_Click...
		private void BtnLastPage_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnLastPage_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnAttachment_Click...
		private void BtnAttachment_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnAttachment_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnFlow_Click...
		private void BtnFlow_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnFlow_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnOutput_Click...
		private void BtnOutput_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnOutput_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnPrint_Click...
		private void BtnPrint_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnPrint_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnOk_Click...
		private void BtnOk_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
			
		
			BtnOk_Click_DefaultImpl(sender,e);
		}	
		 
				//BtnClose_Click...
		private void BtnClose_Click_Extend(object sender, EventArgs  e)
		{
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.

            this.CloseDialog(true);
			BtnClose_Click_DefaultImpl(sender,e);
		}	
		 
				//OnAllocation0_Click...
		private void OnAllocation0_Click_Extend(object sender, EventArgs  e)
		{
            
			//调用模版提供的默认实现.--默认实现可能会调用相应的Action.
            //出运明细单保存
            //if(this.Code70.Text.Trim() == "")
            //    throw new Exception("没有发票号组编码");
            //if (this.Model.BillNoItemHead.FocusedRecord == null)
            //    throw new Exception("没有发票号组信息");
            if (this.Model.BillNoItemHead_BillNoItemLine.Records.Count <= 0)
            {
                //throw new Exception("没有发票号信息");
                this.Model.ErrorMessage.Message = "没有发票号信息";
                return;
            }
            //else if (this.Model.BillNoItemHead_BillNoItemLine.Records.Count == 1)
            //{
            //    if (this.Model.BillNoItemHead_BillNoItemLine.FocusedRecord.ID <= 0)
            //    {
            //        this.Model.ErrorMessage.Message = "请录入发票号";
            //        return;
            //    }

            //}
            //勾选的出运明细单必须是同一种装柜方式

            if (this.Model.BilAlllcationShipPlanView.SelectRecords.Count <= 0)
            {
                //this.Model.ErrorMessage.Message = "没有选择出运明细单";
                //return;
                throw new Exception("没有选择出运明细单");
            }
            UFIDA.U9.Cust.GS.FT.OperateShipPlanBP.Proxy.AllocationBillNoProxy proxy = new OperateShipPlanBP.Proxy.AllocationBillNoProxy();
            List<long> listShipPlan = new List<long>();
            //不同币种、接单组织、外销员、出运日期的出运明细单不允许分配同一个发票号组
            string parkType = "", currenty = "", saleMan = "";
            int count = 0;
            long  org = 0;
            DateTime shipPlanDate = DateTime.Now;
            foreach (BilAlllcationShipPlanViewRecord recourd in this.Model.BilAlllcationShipPlanView.SelectRecords)
            {
                ////放在BP校验
                //if (count > 0)
                //{
                //    if (parkType != "" && parkType != recourd.ParkingType)   //出运明细单必须是同一种装柜方式；
                //    {
                //        throw new Exception("出运明细单" + recourd.ShipPlanDetailHead_DocNo + "与其他不为同一种装柜方式");
                //    }
                //    //不同币种、接单组织、外销员、出运日期的出运明细单不允许分配同一个发票号组；
                //    if (currenty != recourd.Currency)
                //    {
                //        throw new Exception("出运明细单" + recourd.ShipPlanDetailHead_DocNo + "与其他明细单不为同一种币种");
                //    }
                //    if (org != recourd.Org)
                //    {
                //        throw new Exception("出运明细单" + recourd.ShipPlanDetailHead_DocNo + "与其他明细单不为相同接单组织");
                //    }
                //    if (saleMan != recourd.SaleMan)
                //    {
                //        throw new Exception("出运明细单" + recourd.ShipPlanDetailHead_DocNo + "与其他明细单不为同一个业务员");
                //    }
                //    if (shipPlanDate.ToString("yyyy-MM-dd") != (recourd.Date??DateTime.Now).ToString("yyyy-MM-dd"))
                //    {
                //        throw new Exception("出运明细单" + recourd.ShipPlanDetailHead_DocNo + "与其他明细单出运日期不同");
                //    }
                //}
                if(!listShipPlan.Contains(recourd.ShipPlanDetailHead ?? 0))
                {
                    listShipPlan.Add(recourd.ShipPlanDetailHead ?? 0);
                }
                parkType = recourd.ParkingType;
                currenty = recourd.Currency;
                saleMan = recourd.SaleMan;
                org = recourd.Org ?? 0;
                count++;
            }
            BtnSave_Click_DefaultImpl(sender, e);
            proxy.ShipPlanList = listShipPlan;
            proxy.Type = 0;
            proxy.BillNoItemHead = this.Model.BillNoItemHead.FocusedRecord.ID;
            //if (BtnOk.Visible)
            //{
            //    BtnOk_Click(sender, e);
            //}
            int result = proxy.Do();
            if (result > 0)
            {
                if (NavigateManager.IsTitleLink(this) || NavigateManager.IsModelPopup(this))
                {
                    //BtnOk_Click(sender, e);
                    this.CloseDialog(true);
                }
                else
                {
                    //分配的发票号组更新到明细单界面
                }
            }
            OnAllocation0_Click_DefaultImpl(sender, e);
		}
        /// <summary>
        /// 取消分配
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void OnCancelAllocation84_Click_Extend(object sender, EventArgs e)
        {
           if(this.Model.BillNoItemHead.FocusedRecord == null)
               throw new Exception("没有发票号组");
            if(this.Model.BillNoItemHead.FocusedRecord != null && this.Model.BillNoItemHead.FocusedRecord.BillNoItemStates == 0)
                throw new Exception("发票号组未分配，无需取消分配");
            if (this.Model.BilAlllcationShipPlanView.SelectRecords.Count <= 0)
            {
                throw new Exception("没有选择出运明细单");
            }
            UFIDA.U9.Cust.GS.FT.OperateShipPlanBP.Proxy.AllocationBillNoProxy proxy = new OperateShipPlanBP.Proxy.AllocationBillNoProxy();
            //proxy.BillNoItemHead = this.Model.BillNoItemHead.FocusedRecord.Key;
            List<long> listShipPlan = new List<long>();
            foreach (BilAlllcationShipPlanViewRecord recourd in this.Model.BilAlllcationShipPlanView.SelectRecords)
            {
                if (!listShipPlan.Contains(recourd.ShipPlanDetailHead ?? 0))
                {
                    listShipPlan.Add(recourd.ShipPlanDetailHead ?? 0);
                }
            }
            proxy.ShipPlanList = listShipPlan;
            proxy.Type = 4;
            int result = proxy.Do();
            if (result > 0)
            {
                if (this.BtnOk.Visible)
                {
                    this.CloseDialog(true);
                }
                else
                {
                    foreach (BilAlllcationShipPlanViewRecord recourd in this.Model.BilAlllcationShipPlanView.SelectRecords)
                    {
                        recourd.Remove();
                    }
                }
            }
            OnCancelAllocation84_Click_DefaultImpl(sender, e);
        }
            
            
            

		#region 自定义数据初始化加载和数据收集
		private void OnLoadData_Extend(object sender)
		{
          
			OnLoadData_DefaultImpl(sender);
		}
		private void OnDataCollect_Extend(object sender)
		{
            this.Model.ClearErrorMessage();
			OnDataCollect_DefaultImpl(sender);
		}
		#endregion  

        #region 自己扩展 Extended Event handler 
		public void AfterOnLoad()
		{
            //if (this.Model.BilAlllcationShipPlanView.FocusedRecord == null)
            //    this.Model.BilAlllcationShipPlanView.AddNewUIRecord();
            if (this.Model.BillNoItemHead.FocusedRecord == null)
            {
                this.Model.BillNoItemHead.AddNewUIRecord();
                if (this.Model.BillNoItemHead_BillNoItemLine.FocusedRecord == null)
                {
                    this.Model.BillNoItemHead_BillNoItemLine.AddNewUIRecord().SetParentRecord(this.Model.BillNoItemHead.FocusedRecord);
                }
            }
            
		}

        public void AfterCreateChildControls()
        {

            //查找
            //取得当前卡片参照的属性变量：FormID、Width、Height、Title；
            //传递隐藏域wpFindID的客户端ID；注意：隐藏域wpFindID会记录参照选择的记录ID；
            PDFormMessage.ShowConfirmDialog(this.Page, "8c90a085-02ae-4385-a324-1dd8caac0e63", Title, wpFindID.ClientID, this.BtnFind, null);

            //拉单
            // PDFormMessage.ShowConfirmDialog(this.Page, "2a8fdf43-38d4-4108-bc9c-dc254cc314b1","820","680", Title, wpFindID.ClientID,(IUFButton)this.PODocNO90, null);



            // 实现个性化
            UFIDA.U9.UI.PDHelper.PersonalizationHelper.SetPersonalizationEnable(this, true);

            // 实现删除提示是否需要删除
            UFIDA.U9.UI.PDHelper.PDFormMessage.ShowDelConfirmDialog(this.Page, UFIDA.U9.UI.PDHelper.PDResource.GetDeleteConfirmInfo(), "是否删除该记录信息", this.BtnDelete);

            //实现弹性域控件绑定
            FlexFieldHelper.SetDescFlexField(this.FlexFieldPicker0, this.Model.BillNoItemHead);

            //行弹性域控件绑定  
            FlexFieldHelper.SetDescFlexField(this.DataGrid6, this.DataGrid6.Columns.Count - 1, "DescFlilxFiled");

            ShipCellDataChangedPostBack(); //出运明细单选择

            BillCellDataChangedPostBack();
           
        }
        
        public void AfterEventBind()
        {
        }
        
		public void BeforeUIModelBinding()
		{
 
            SetButtonState();
            LoadShipPlanDoc();
             if (this.NameValues != null && this.NameValues["BillNoItem"] != null)
             {
                 //按照发票号查找预装柜表数据
                 //long billNoItem = Convert.ToInt64(this.NameValues["BillNoItem"].ToString());
                 //this.Action.NavigateAction.MovePageAt(null, billNoItem);
             }
             ((UFSoft.UBF.UI.ControlModel.IUIFieldBindingDataBindControl)this.BillNoItemStates109).ReadOnly = true;//状态
             this.DataGrid5.Columns["Date"].Enabled = false;
             this.DataGrid5.Columns["Org"].Enabled = false;
             this.DataGrid5.Columns["Customer"].Enabled = false;
             this.DataGrid5.Columns["Date"].Enabled = false;
             //参数过滤条件
             this.SetControlCustomInParams();
		}
        /// <summary>
        /// 设置控件过滤条件、属性
        /// </summary>
        private void SetControlCustomInParams()
        {
            //发票号过滤
            if (this.Model.BillNoItemHead_BillNoItemLine.Records.Count > 0)
            {
                string billNo = "";
                foreach (BillNoItemHead_BillNoItemLineRecord record in this.Model.BillNoItemHead_BillNoItemLine.Records)
                {
                    if(record.BillNoid > 0)
                        billNo += record.BillNoid + ",";
                }
                if (billNo != "")
                {
                    billNo = billNo.Substring(0, billNo.Length - 1);
                    if (billNo != "")
                    {
                        IUFFldReferenceColumn billNoRef = (IUFFldReferenceColumn)this.DataGrid6.Columns["BillNoid"];
                        //billNoRef.CustomInParams = BaseAction.Symbol_AddCustomFilter + "=ID not in (" + billNo + ")";
                        billNoRef.CustomInParams = BaseAction.Symbol_AddCustomFilter + "= ID not in (" + billNo + ")";
                    }
                }
            }
            //出运明细过滤
            if (this.Model.BilAlllcationShipPlanView.Records.Count > 0)
            {
                string shipDoc = "";
                foreach (BilAlllcationShipPlanViewRecord record in this.Model.BilAlllcationShipPlanView.Records)
                {
                    if (record.ShipPlanDetailHead > 0)
                        shipDoc += record.ShipPlanDetailHead + ",";
                }
                if (shipDoc != "")
                {
                    shipDoc = shipDoc.Substring(0, shipDoc.Length - 1);
                    if (shipDoc != "")
                    {
                        IUFFldReferenceColumn shipHeadRef = (IUFFldReferenceColumn)this.DataGrid5.Columns["ShipPlanDetailHead"];
                        //billNoRef.CustomInParams = BaseAction.Symbol_AddCustomFilter + "=ID not in (" + billNo + ")";
                        shipHeadRef.CustomInParams = BaseAction.Symbol_AddCustomFilter + "= ID not in (" + shipDoc + ")";
                    }
                }
            }
        }
		public void AfterUIModelBinding()
		{
            //LoadShipPlanDoc();

		}
        //	页面进入时，默认为对新的出运明细单进行发票号的分配，默认加载出运明细单.单据状态=审核中 and 出运明细单.已分配发票号=false的所有出运明细单；
        private void LoadShipPlanDoc()
        {
            //if (this.Model.BillNoItemHead.FocusedRecord == null && this.Model.BilAlllcationShipPlanView.RecordCount > 0)
            //    return;
            UFIDA.U9.Cust.GS.FT.OperateShipPlanBP.Proxy.GetShipPlanDocProxy proxy = new OperateShipPlanBP.Proxy.GetShipPlanDocProxy();
            List<UFIDA.U9.Cust.GS.FT.OperateShipPlanBP.ShipPlanByBillHeadDTOData> listShipPlan = new List<OperateShipPlanBP.ShipPlanByBillHeadDTOData>();

            if (this.CurrentState["BillNoRefAllocation"] != null)
            {
                this.Model.BilAlllcationShipPlanView.Clear();
                proxy.BillNoItemHead = (long)this.CurrentState["BillNoRefAllocation"];
            }
            else if (this.NameValues != null && this.NameValues["BillNoItem"] != null && (this.Model.BilAlllcationShipPlanView.RecordCount <= 0 || this.Model.BilAlllcationShipPlanView.RecordCount == 1 && this.Model.BilAlllcationShipPlanView.FocusedRecord.ID == -2))
            {
                this.Model.BilAlllcationShipPlanView.Clear();
                proxy.BillNoItemHead = Convert.ToInt64(this.NameValues["BillNoItem"].ToString());
                //this.Model.BillNoItemHead.Clear();
                //this.Model.BillNoItemHead.CurrentFilter.OPath = this.Model.BillNoItemHead.FieldBillNoItemID.AttributeName + "='" + this.NameValues["BillNoItem"].ToString() + "'";
                //this.Action.CommonAction.Load(this.Model.BillNoItemHead);
                this.Action.NavigateAction.MovePageAt(null, Convert.ToInt64(this.NameValues["BillNoItem"].ToString()));
            }
            else if (this.CurrentState["Cust_BillNoShipPlan"] != null)
            {
                BilAlllcationShipPlanViewRecord recourd = null;
                if (this.Model.BilAlllcationShipPlanView.FocusedRecord != null)
                    recourd = this.Model.BilAlllcationShipPlanView.FocusedRecord;
                else
                    recourd = this.Model.BilAlllcationShipPlanView.AddNewUIRecord();
                recourd.ShipPlanDetailHead = Convert.ToInt64(this.NameValues["ShipPlanDetailHead"]);
                recourd.ShipPlanDetailHead_DocNo = this.NameValues["ShipPlanDetailHead_DocNo"].ToString();
                recourd.Date = DateTime.Parse(this.NameValues["Date"].ToString());
                recourd.Customer = Convert.ToInt64(this.NameValues["Customer"]);
                recourd.Customer_Code = this.NameValues["Customer_Code"].ToString();
                recourd.Customer_Name = this.NameValues["Customer_Name"].ToString();
                recourd.Org = Convert.ToInt64(this.NameValues["Org"]);
                recourd.Org_Code = this.NameValues["Org_Code"].ToString();
                recourd.Org_Name = this.NameValues["Org_Name"].ToString();
                recourd.Currency = this.NameValues["Currency"].ToString();
                recourd.SaleMan = this.NameValues["SaleMan"].ToString();
                recourd.ParkingType = this.NameValues["ParkingType"].ToString();
                recourd.BillNoItem = this.NameValues["CustBillNoItem"].ToString() == "" ?0: Convert.ToInt64(this.NameValues["CustBillNoItem"]);
                recourd.BillNoItem_Code = this.NameValues["CustBillNoItem_Name"].ToString();
                recourd.BillNoItem_Name = this.NameValues["CustBillNoItem_Name"].ToString();
                this.CurrentState["Cust_BillNoShipPlan"] = null;
                return;
            }
            else
                return;
            proxy.Type = 0;
            listShipPlan = proxy.Do();
            if (listShipPlan != null)
            {
                BilAlllcationShipPlanViewRecord recourd = this.Model.BilAlllcationShipPlanView.FocusedRecord;
                foreach (UFIDA.U9.Cust.GS.FT.OperateShipPlanBP.ShipPlanByBillHeadDTOData shipDoc in listShipPlan)
                {
                    recourd = this.Model.BilAlllcationShipPlanView.AddNewUIRecord();
                    recourd.ShipPlanDetailHead = shipDoc.ShipPlan;
                    recourd.ShipPlanDetailHead_DocNo = shipDoc.DocNo;
                    recourd.Date = shipDoc.Date;
                    recourd.Customer = shipDoc.Customer;
                    recourd.Customer_Code = shipDoc.Customer_Code;
                    recourd.Customer_Name = shipDoc.Customer_Name;
                    recourd.Org = shipDoc.Org;
                    recourd.Org_Code = shipDoc.Org_Code;
                    recourd.Org_Name = shipDoc.Org_Name;
                    recourd.Currency = shipDoc.Currenty.ToString();
                    recourd.SaleMan = shipDoc.SaleMan.ToString();
                    recourd.ParkingType = shipDoc.PackagingType;
                    recourd.BillNoItem = shipDoc.BillNoItem;
                    recourd.BillNoItem_Code = shipDoc.BillNoItem_Name;
                    recourd.BillNoItem_Name = shipDoc.BillNoItem_Name;
                }
            }
            this.CurrentState["BillNoRefAllocation"] = null;
        }

        #region 出运明细 改变事件
        private void ShipCellDataChangedPostBack()
        {
            AssociationControl assocControl = new AssociationControl();
            assocControl.SourceServerControl = this.DataGrid5;
            assocControl.SourceControl.EventName = "OnCellDataChanged";
            ((IUFClientAssoGrid)assocControl.SourceControl).FireEventCols.Add("ShipPlanDetailHead");
            CodeBlock cb = new CodeBlock();
            UFWebClientGridAdapter gridAdapter = new UFWebClientGridAdapter(this.DataGrid5);
            gridAdapter.IsPostBack = true;
            gridAdapter.PostBackTag = "OnCellDataChanged";//OnCellDataValueChanged
            cb.TargetControls.addControl(gridAdapter);
            assocControl.addBlock(cb);
            UFGrid itemGrid = this.DataGrid5 as UFGrid;
            itemGrid.GridCustomerPostBackEvent += new GridCustomerPostBackDelegate(itemGrid_GridCustomerPostBackEvent);

        }
        public void itemGrid_GridCustomerPostBackEvent(object sender, GridCustomerPostBackEventArgs e)
        {
            if (e.ColIndex == -1) return;
            if (e.RowIndex == -1) return;
            this.DataGrid5.CollectData();
            this.DataGrid5.BindData();
            DataTable dt = this.CurrentState["BillNoAllocationShip"] as DataTable;//参照中选择的数据
            if (dt != null && dt.Rows.Count > 0)
            {
                BilAlllcationShipPlanViewRecord recourd = null;
                recourd = this.Model.BilAlllcationShipPlanView.FocusedRecord;
               // if(recourd.ShipPlanDetailHead != null && recourd.ShipPlanDetailHead != long.Parse(dt.Rows[0]["ID"].ToString())
                recourd.ShipPlanDetailHead = long.Parse(dt.Rows[0]["ID"].ToString());
                recourd.ShipPlanDetailHead_DocNo = dt.Rows[0]["DocNo"].ToString();
                recourd.Date = DateTime.Parse(dt.Rows[0]["Date"].ToString());
                recourd.Customer = long.Parse(dt.Rows[0]["Customer"].ToString());
                recourd.Customer_Code = dt.Rows[0]["Customer_Code"].ToString();
                recourd.Customer_Name = dt.Rows[0]["Customer_Name"].ToString();
                recourd.Org = long.Parse(dt.Rows[0]["Org"].ToString());
                recourd.Org_Code = dt.Rows[0]["Org_Code"].ToString();
                recourd.Org_Name = dt.Rows[0]["Org_Name"].ToString();
                recourd.ParkingType = dt.Rows[0]["ParkingType"].ToString();
                recourd.BillNoItem = long.Parse(dt.Rows[0]["BillNoItem"].ToString());
                recourd.BillNoItem_Code = dt.Rows[0]["BillNoItem_Name"].ToString();
                recourd.BillNoItem_Name = dt.Rows[0]["BillNoItem_Name"].ToString();
                recourd.IsSelected = true;
                for (int i = 1; i < dt.Rows.Count; i++)
                {
                    recourd = this.Model.BilAlllcationShipPlanView.AddNewUIRecord();
                    recourd.ShipPlanDetailHead = long.Parse(dt.Rows[i]["ID"].ToString());
                    recourd.ShipPlanDetailHead_DocNo = dt.Rows[i]["DocNo"].ToString();
                    recourd.Date = DateTime.Parse(dt.Rows[i]["Date"].ToString());
                    recourd.Customer = long.Parse(dt.Rows[i]["Customer"].ToString());
                    recourd.Customer_Code = dt.Rows[i]["Customer_Code"].ToString();
                    recourd.Customer_Name = dt.Rows[i]["Customer_Name"].ToString();
                    recourd.Org = long.Parse(dt.Rows[i]["Org"].ToString());
                    recourd.Org_Code = dt.Rows[i]["Org_Code"].ToString();
                    recourd.Org_Name = dt.Rows[i]["Org_Name"].ToString();
                    recourd.ParkingType = dt.Rows[i]["ParkingType"].ToString();
                    recourd.BillNoItem = long.Parse(dt.Rows[i]["BillNoItem"].ToString());
                    recourd.BillNoItem_Code = dt.Rows[i]["BillNoItem_Name"].ToString();
                    recourd.BillNoItem_Name = dt.Rows[i]["BillNoItem_Name"].ToString();
                    recourd.IsSelected = true;
                }
            }
            this.CurrentState["BillNoAllocationShip"] = null;
            this.DataGrid5.CollectData();
            this.DataGrid5.BindData();

        }
        #endregion

        #region 发票号改变事件
        private void BillCellDataChangedPostBack()
        {
            AssociationControl assocControl = new AssociationControl();
            assocControl.SourceServerControl = this.DataGrid6;
            assocControl.SourceControl.EventName = "OnCellDataChanged";
            ((IUFClientAssoGrid)assocControl.SourceControl).FireEventCols.Add("BillNoid");
            CodeBlock cb = new CodeBlock();
            UFWebClientGridAdapter gridAdapter = new UFWebClientGridAdapter(this.DataGrid6);
            gridAdapter.IsPostBack = true;
            gridAdapter.PostBackTag = "OnCellDataChanged";//OnCellDataValueChanged
            cb.TargetControls.addControl(gridAdapter);
            assocControl.addBlock(cb);
            UFGrid billGrid = this.DataGrid6 as UFGrid;
            billGrid.GridCustomerPostBackEvent += new GridCustomerPostBackDelegate(billGrid_GridCustomerPostBackEvent);

        }
        public void billGrid_GridCustomerPostBackEvent(object sender, GridCustomerPostBackEventArgs e)
        {
            if (e.ColIndex == -1) return;
            if (e.RowIndex == -1) return;

            this.DataCollect();
            DataTable dt = this.CurrentState["ReturnShipBillNoListID"] as DataTable;//参照中选择的数据
            if (dt != null && dt.Rows.Count > 0)
            {
                BillNoItemHead_BillNoItemLineRecord recourd = null;
                recourd = this.Model.BillNoItemHead_BillNoItemLine.FocusedRecord;
                if (recourd == null)
                {
                     //this.Model.ErrorMessage.Message = "没有发票号信息";
                     //return;
                    //DataGrid6.CollectData();
                    //DataGrid6.BindData();
                    //return;
                    recourd = this.Model.BillNoItemHead_BillNoItemLine.AddNewUIRecord();
                }
                recourd.BillNoid = long.Parse(dt.Rows[0]["ID"] + "");
                recourd.BillNoid_BillNoID = dt.Rows[0]["Code"] + "";
                recourd.BillNoid_BillNoID = dt.Rows[0]["Name"] + "";
                //recourd.SetParentRecord(this.Model.BillNoItemHead.FocusedRecord);
                for (int i = 1; i < dt.Rows.Count; i++)
                {
                    recourd = this.Model.BillNoItemHead_BillNoItemLine.AddNewUIRecord();
                    recourd.BillNoid = long.Parse(dt.Rows[i]["ID"] + "");
                    recourd.BillNoid_BillNoID = dt.Rows[i]["Code"] + "";
                    recourd.BillNoid_BillNoID = dt.Rows[i]["Name"] + "";
                    recourd.SetParentRecord(this.Model.BillNoItemHead.FocusedRecord);
                }
            }
            this.CurrentState["ReturnShipBillNoListID"] = null;
            //DataGrid6.CollectData();
            //DataGrid6.BindData();
            //this.DataCollect();
        }
        #endregion

        //设置单据界面右下角 ”确定，取消“按钮的显示和隐藏
        private void SetButtonState()
        {

            //if (this.PageStatus == UFSoft.UBF.UI.IView.PartStateType.Insert)
            //    ButtonManger.SetToolBarNewStatus(Toolbar2, 0);
            //else
            //    ButtonManger.SetToolBarModifyStatus(Toolbar2, 0);

            //如果页面是通过TitleLink进入则显示确定取消按钮
            if (NavigateManager.IsTitleLink(this))
            {
                this.BtnOk.Visible = true;
                this.BtnClose.Visible = true;

                BtnList.Enabled = false;
            }
            else if (NavigateManager.IsModelPopup(this))
            {
                this.BtnOk.Visible = false;
                this.BtnClose.Visible = false;

                BtnList.Enabled = false;
            }
            else
            {
                this.BtnOk.Visible = false;
                this.BtnClose.Visible = false;

                BtnList.Enabled = true;
            }
        }

        #endregion

        #endregion

    }
}